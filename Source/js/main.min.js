var reddcoinRocks=angular.module("reddcoinRocks",["ngAnimate","ipCookie","pusher-angular","ngActivityIndicator","ui.bootstrap","720kb.socialshare","monospaced.qrcode","timer","angulartics","angulartics.google.analytics"]),socket=io("http://live.reddcoin.com/");jQuery.cachedScript=function(a,b){return b=$.extend(b||{},{dataType:"script",cache:!0,url:a}),jQuery.ajax(b)},reddcoinRocks.directive("selectOnClick",function(){return{restrict:"A",link:function(a,b){b.on("click",function(){this.select()})}}}),reddcoinRocks.filter("humanize",function(){return function(a,b,c,d){b=isNaN(b)?2:Math.abs(b),c=void 0===c?".":c,d=void 0===d?",":d;var e=0>a?"-":"";a=Math.abs(+a||0);var f=parseInt(a.toFixed(b),10)+"",g=f.length>3?f.length%3:0;return e+(g?f.substr(0,g)+d:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+d)+(b?c+Math.abs(a-f).toFixed(b).slice(2):"")}}),reddcoinRocks.directive("compile",["$compile",function(a){return function(b,c,d){b.$watch(function(a){return a.$eval(d.compile)},function(d){c.html(d),a(c.contents())(b)})}}]),reddcoinRocks.service("rddPriceService",["$http",function(a){this.getPrice=function(){return a({url:"http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22"+encodeURIComponent("http://pubapi.cryptsy.com/api.php?method=singlemarketdata&marketid=169")+"%22&format=json"})}}]),reddcoinRocks.service("btcPriceService",["$http",function(a){this.getPrice=function(){return a({url:"https://api.bitcoinaverage.com/exchanges/USD"})}}]),reddcoinRocks.service("rddTxService",["$http",function(a){this.getTransactionData=function(b){return a({url:"http://live.reddcoin.com/api/tx/"+b})}}]),reddcoinRocks.service("rddTxListService",["$http",function(a){this.getTransactionData=function(b){return a({url:"http://live.reddcoin.com/api/txs?address="+b+"&pageNum=0"})}}]),reddcoinRocks.service("rddShortUrlService",["$http",function(a){this.getShortUrl=function(b){return a({url:"http://rdd.pw/yourls-api.php",method:"JSONP",params:{callback:"JSON_CALLBACK",username:"reddcoinrocks",password:"Hs8H8ehU",action:"shorturl",format:"jsonp",title:"Reddcoin Rocks!",url:b}})}}]),reddcoinRocks.controller("walletData",["$scope","$filter","$timeout","$http","rddTxService","rddTxListService","rddShortUrlService","ipCookie","$modal","$sce",function(a,b,c,d,e,f,g,h,i){a.shorteningUrl=!1,a.totalStaked=0,a.lastStaked=0,a.audioActive=h(a.wallet+"_audio"),a.isStakeTransaction=function(a){return a.isCoinStake&&!isNaN(parseFloat(a.fees))},a.isStakeTransactionFilter=function(){return a.isStakeTransaction},a.showStakeNotification=function(c,d){notify.createNotification(c,{body:"New stake reward: \u024c"+b("humanize")(d,8,".",","),icon:"icon.png"}),a.audioActive&&a.$parent.audioScripLoaded&&(a.$parent.lastSpeak&&meSpeak.stop(a.$parent.lastSpeak),a.$parent.lastSpeak=meSpeak.speak("New stake reward: "+d+" reddcoins",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"}))},a.removeWallet=function(){var b=a.$parent.wallets.indexOf(a.wallet);a.$parent.wallets.splice(b,1),socket.removeAllListeners(a.wallet),h("wallets",a.$parent.wallets,{expires:1e4})},a.toggleAudio=function(){a.audioActive?(h(a.wallet+"_audio",!1,{expires:1e4}),a.$parent.lastSpeak&&meSpeak.stop(a.$parent.lastSpeak),a.$parent.lastSpeak=meSpeak.speak("You have disabled audio notifications for this address",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"}),a.audioActive=!1):(h(a.wallet+"_audio",!0,{expires:1e4}),a.audioActive=!0,a.$parent.audioScripLoaded?(a.$parent.lastSpeak&&meSpeak.stop(a.$parent.lastSpeak),a.$parent.lastSpeak=meSpeak.speak("You have enabled audio notifications for this address",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"})):$.cachedScript("js/vendor/mespeak.js").done(function(){meSpeak.loadConfig("js/vendor/mespeak_config.json"),meSpeak.loadVoice("js/vendor/voices/en/en.json"),a.$parent.lastSpeak&&meSpeak.stop(a.$parent.lastSpeak),a.$parent.lastSpeak=meSpeak.speak("You have enabled audio notifications for this address",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"}),a.$parent.audioScripLoaded=!0}))},a.watchWallet=function(a){socket.emit("subscribe",a.wallet),socket.on(a.wallet,function(b){e.getTransactionData(b).then(function(b){window.setTimeout(function(){a.updateWallet(a)},24e4);var c=b.data;if(a.transactions.push(c),a.isStakeTransaction(c)){var d=-1*c.fees,e=notify.permissionLevel();(e=notify.PERMISSION_DEFAULT)?notify.requestPermission(function(){notify.permissionLevel()==notify.PERMISSION_GRANTED&&a.showStakeNotification(a.wallet,d)}):e==notify.PERMISSION_GRANTED&&a.showStakeNotification(a.wallet,d)}else a.newTransactions?a.newTransactions+=1:a.newTransactions=1})})},a.lastUpdate,a.updateWallet=function(a){a.updatePromise&&c.cancel(a.updatePromise),a.updatePromise=c(function(){if(!(a.lastUpdate&&new Date-a.lastUpdate<1e4)){a.lastUpdate=new Date;var b="http://live.reddcoin.com/api/addr/"+a.wallet+"/balance";d({url:b}).success(function(b){a.balance=b/1e8,f.getTransactionData(a.wallet).then(function(b){if(a.transactions=b.data.txs,a.transactions&&a.transactions.length>0){a.lastTime=0;var d=0;a.totalStaked=0,$.each(a.transactions,function(b,c){a.isStakeTransaction(c)&&c.confirmations>0&&(c.time>a.lastTime&&(a.lastTime=c.time,d=-1*c.fees),(1e3*c.time<a.lastStaked||0==a.lastStaked)&&(a.lastStaked=1e3*c.time),a.totalStaked+=-1*c.fees)}),a.totalStakeTime=a.lastStaked&&a.lastStaked!=Number.POSITIVE_INFINITY?' <td><strong>Total (last <timer start-time="'+a.lastStaked+"\" interval=\"1000\"><span ng-show=\"days\">{{days}}d </span><span ng-show=\"hhours\">{{hhours}}h </span><span ng-show=\"mminutes\">{{mminutes}}m </span><span>{{sseconds}}s</span></timer>)</strong></td><td><strong>\u024c{{totalStaked | humanize:8:'.':','}}</strong></td><td><strong>\u0e3f{{totalStaked* $parent.$parent.rddPrice | humanize:8:'.':','}}</strong></td><td><strong>${{totalStaked * $parent.$parent.rddDollarPrice | humanize:8:'.':','}}</strong></td><td><strong>&gt; 0</strong></td>":0,a.intervalFunction=function(){c(function(){a.lastRewardSeconds=new Date-new Date(1e3*a.lastTime),a.avgPercentage=a.lastTime&&a.lastTime!=Number.POSITIVE_INFINITY?'<span ng-hide="percentage > 1000">{{(percentage = (lastRewardSeconds / (seconds * 1000)) * 100) | humanize:0:\'.\':\',\'}}% of estimate</span><span class="label label-danger" ng-show="percentage > 1000"><span class="glyphicon glyphicon-off" aria-hidden="true"></span> Wallet seems to be offline</span>':0,a.intervalFunction()},1e3)},a.intervalFunction(),a.lastReward=a.lastTime&&a.lastTime!=Number.POSITIVE_INFINITY?'<timer start-time="'+1e3*a.lastTime+'" interval="1000"><span ng-show="days">{{days}} day{{daysS}}, </span><span ng-show="hours">{{hours}} hour{{hoursS}}, </span><span ng-show="minutes">{{minutes}} minute{{minutesS}} and </span><span>{{seconds}} second{{secondsS}}</span> ago</timer>':0}});var j="http://live.reddcoin.com/api/addr/"+a.wallet+"/utxo?noCache=1";d({url:j}).success(function(b){if(b.sort(function(a,b){return new Date(1e3*a.ts)-new Date(1e3*b.ts)}),a.unspendTransactions&&a.unspendTransactions.length!=b.length){var h;$.each(b,function(b,c){new Date(1e3*c.ts)>new Date(1e3*a.unspendTransactions[a.unspendTransactions.length-1].ts)&&c.txid!=h&&(h=c.txid,e.getTransactionData(c.txid).then(function(b){var c=b.data;if(c.confirmations>0)if(a.isStakeTransaction(c)){var d=-1*c.fees,e=notify.permissionLevel();(e=notify.PERMISSION_DEFAULT)?notify.requestPermission(function(){notify.permissionLevel()==notify.PERMISSION_GRANTED&&a.showStakeNotification(a.wallet,d)}):e==notify.PERMISSION_GRANTED&&a.showStakeNotification(a.wallet,d)}else a.newTransactions?a.newTransactions+=1:a.newTransactions=1}))})}a.unspendTransactions=b,a.$parent.$watch("networkWeight",function(){a.updateStakeInfo(a)}),a.latestDiff?(a.latestDiff=a.latestDiffUpdate,a.networkWeight=a.networkWeightUpdate):d({url:"http://live.reddcoin.com/api/status?q=getDifficulty"}).success(function(b){a.latestDiff=b.difficulty,a.networkWeight=Math.round(4294967296*a.latestDiff/60)}).error(function(a){console.log("error",a)})}).error(function(a){console.log("error",a)})}).error(function(a){console.log("error",a)})}},1e3)},a.$on("timer-stopped",function(b,c){0==c.seconds&&b.targetScope.countdownattr==a.countdown&&a.updateWallet(a)}),a.updateStakeInfo=function(a){a.totalcoinweight=0;var b=0;$.each(a.unspendTransactions,function(c,d){nowtime=Math.round((new Date).getTime()/1e3);var e=nowtime-d.ts-28800,f=e/60/60/24,g=0;b=7>=f?-.00408163*Math.pow(f,3)+.05714286*Math.pow(f,2)+f:8.4*Math.log(f)-7.94564525,d.confirmations>=0&&(g=b*d.amount),g>=0&&(a.totalcoinweight+=g)}),a.seconds=Math.round(60*(a.$parent.networkWeight/a.totalcoinweight)).toFixed(0),a.countdown=Math.min(a.seconds,1800),a.avgStakeTimespan=a.seconds&&a.seconds!=Number.POSITIVE_INFINITY?'<timer interval="1000" start-time="'+((new Date).getTime()-1e3*a.seconds)+'" end-time="'+((new Date).getTime()-1e3*a.seconds)+'" autostart="false"><span ng-show="days">{{days}} day{{daysS}}, </span><span ng-show="hours">{{hours}} hour{{hoursS}}, </span><span ng-show="minutes">{{minutes}} minute{{minutesS}} and </span><span>{{seconds}} second{{secondsS}}</span></timer>':0,a.estStakeTimespan=a.seconds&&a.seconds!=Number.POSITIVE_INFINITY?'<timer countdown="'+a.countdown+'" interval="1000"><div class="progress active"> <div class="progress-bar progress-bar-info" ng-style="{\'width\': ((countdown/$parent.countdown) * 100) + \'%\'}"><span>&nbsp;&nbsp;</span><span ng-show="days">{{days}} day{{daysS}}, </span><span ng-show="hours">{{hours}} hour{{hoursS}}, </span><span ng-show="minutes">{{minutes}} minute{{minutesS}} and </span><span>{{seconds}} second{{secondsS}}</span></div> </div></timer>':"not staking because the address doesn't have mature coins",a.estStake=(Math.round(a.$parent.networkWeight/a.totalcoinweight)/60).toFixed(2),a.estStakeInDays=(a.estStake/24).toFixed(2),a.$broadcast("timer-start")},a.openShareLayer=function(b){var c="http://reddcoin.rocks/#"+a.wallet;a.shortLink?a.openShareLayerInternal(b):(a.shorteningUrl=!0,g.getShortUrl(c).then(function(c){a.shortLink=c.data.shorturl,a.shorteningUrl=!1,a.openShareLayerInternal(b)},function(){a.shortLink=c,a.shorteningUrl=!1,a.openShareLayerInternal(b)}))},a.openShareLayerInternal=function(b){i.open({templateUrl:"sharelayer.html",controller:"shareLayer",size:b,resolve:{shortLink:function(){return a.shortLink},wallet:function(){return a.wallet}}})},a.wallet&&34==a.wallet.length&&(a.updateWallet(a),a.watchWallet(a),a.audioActive&&!a.$parent.audioScripLoaded&&$.cachedScript("js/vendor/mespeak.js").done(function(){meSpeak.loadConfig("js/vendor/mespeak_config.json"),meSpeak.loadVoice("js/vendor/voices/en/en.json"),a.$parent.audioScripLoaded=!0}))}]),reddcoinRocks.controller("shareLayer",["$scope","$modalInstance","shortLink","wallet",function(a,b,c,d){a.shortLink=c,a.wallet=d,a.cancel=function(){b.dismiss("cancel")}}]),reddcoinRocks.controller("stakingInfo",["$scope","$http","btcPriceService","rddPriceService","$pusher","ipCookie","$activityIndicator",function(a,b,c,d,e,f,g){a.btcPriceUp=!0,a.rddPriceUp=!0,a.rddDollarPriceUp=!0,a.audioScripLoaded=!1;var h=document.createElement("audio");a.canPlayAudioNotifications="function"==typeof h.canPlayType&&""!==h.canPlayType("audio/x-wav"),window.location.hash&&36==window.location.hash.length&&(a.address=window.location.hash.substring(2)),a.wallets=(a.address?[a.address]:f("wallets"))||[],a.wallets.length>0&&g.startAnimating(),b({url:"http://live.reddcoin.com/api/status?q=getDifficulty"}).success(function(b){a.latestDiff=b.difficulty,a.networkWeight=Math.round(4294967296*a.latestDiff/60),g.stopAnimating()}).error(function(a){console.log("error",a)}),socket.on("connect",function(){socket.emit("subscribe","inv")}),socket.on("block",function(){b({url:"http://live.reddcoin.com/api/status?q=getDifficulty"}).success(function(b){a.latestDiffUpdate=b.difficulty,a.networkWeightUpdate=Math.round(4294967296*a.latestDiffUpdate/60)}).error(function(a){console.log("error",a)})}),a.updateRddDollarPrice=function(b,c){if(b||c){var d=(c*b).toFixed(8);d>a.rddDollarPrice&&(a.rddDollarPriceUp=!0),d<a.rddDollarPrice&&(a.rddDollarPriceUp=!1),a.rddDollarPrice=d}};var i=new Pusher("cb65d0a7a72cd94adf1f"),j=e(i),k=new Pusher("de504dc5763aeef9ff52"),l=e(k);c.getPrice().then(function(b){b.data.bitstamp&&b.data.bitstamp.rates.last&&(a.btcPrice=b.data.bitstamp.rates.last,a.updateRddDollarPrice(a.btcPrice,a.rddPrice))}),l.subscribe("live_trades").bind("trade",function(b){b.price>a.btcPrice&&(a.btcPriceUp=!0),b.price<a.btcPrice&&(a.btcPriceUp=!1),a.btcPrice=b.price,a.updateRddDollarPrice(a.btcPrice,a.rddPrice)}),d.getPrice().then(function(b){b.data.query.results&&1==b.data.query.results.json.success&&b.data.query.results.json["return"].markets.RDD.lasttradeprice&&(a.rddPrice=b.data.query.results.json["return"].markets.RDD.lasttradeprice,a.updateRddDollarPrice(a.btcPrice,a.rddPrice))}),j.subscribe("trade.169").bind("message",function(b){b.trade.price>a.rddPrice&&(a.rddPriceUp=!0),b.trade.price<a.rddPrice&&(a.rddPriceUp=!1),a.rddPrice=b.trade.price,a.updateRddDollarPrice(a.btcPrice,a.rddPrice)}),a.getBalance=function(){a.wallet&&34==a.wallet.length&&$.inArray(a.wallet,a.wallets)&&(a.wallets.push(a.wallet),a.wallet="",f("wallets",a.wallets,{expires:1e4}))}}]);