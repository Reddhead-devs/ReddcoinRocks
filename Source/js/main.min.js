var reddcoinRocks=angular.module("reddcoinRocks",["ngAnimate","ipCookie","pusher-angular","ngActivityIndicator","ui.bootstrap","720kb.socialshare","monospaced.qrcode","timer","angulartics","angulartics.google.analytics"]),socket=io("http://live.reddcoin.com/");jQuery.cachedScript=function(e,t){return t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(t)},reddcoinRocks.directive("selectOnClick",function(){return{restrict:"A",link:function(e,t,a){t.on("click",function(){this.select()})}}}),reddcoinRocks.filter("humanize",function(){return function(e,t,a,n){t=isNaN(t)?2:Math.abs(t),a=void 0===a?".":a,n=void 0===n?",":n;var i=0>e?"-":"";e=Math.abs(+e||0);var s=parseInt(e.toFixed(t),10)+"",o=s.length>3?s.length%3:0;return i+(o?s.substr(0,o)+n:"")+s.substr(o).replace(/(\d{3})(?=\d)/g,"$1"+n)+(t?a+Math.abs(e-s).toFixed(t).slice(2):"")}}),reddcoinRocks.directive("compile",["$compile",function(e){return function(t,a,n){t.$watch(function(e){return e.$eval(n.compile)},function(n){a.html(n),e(a.contents())(t)})}}]),reddcoinRocks.service("rddPriceService",["$http",function(e){this.getPrice=function(){return e({url:"http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22"+encodeURIComponent("https://bittrex.com/api/v1.1/public/getticker?market=BTC-RDD")+"%22&format=json"})}}]),reddcoinRocks.service("btcPriceService",["$http",function(e){this.getPrice=function(){return e({url:"https://api.bitcoinaverage.com/exchanges/USD"})}}]),reddcoinRocks.service("rddTxService",["$http",function(e){this.getTransactionData=function(t){return e({url:"http://live.reddcoin.com/api/tx/"+t})}}]),reddcoinRocks.service("rddTxListService",["$http",function(e){this.getTransactionData=function(t){return e({url:"http://live.reddcoin.com/api/txs?address="+t+"&pageNum=0"})}}]),reddcoinRocks.service("rddShortUrlService",["$http",function(e){this.getShortUrl=function(t){return e({url:"http://rdd.pw/yourls-api.php",method:"JSONP",params:{callback:"JSON_CALLBACK",username:"reddcoinrocks",password:"password",action:"shorturl",format:"jsonp",title:"Reddcoin Rocks!",url:t}})}}]),reddcoinRocks.controller("walletData",["$scope","$filter","$timeout","$http","rddTxService","rddTxListService","rddShortUrlService","ipCookie","$modal","$sce",function(e,t,a,n,i,s,o,r,c,d){e.shorteningUrl=!1,e.totalStaked=0,e.lastStaked=0,e.audioActive=r(e.wallet+"_audio"),e.isStakeTransaction=function(e){return e.isCoinStake&&!isNaN(parseFloat(e.fees))},e.isStakeTransactionFilter=function(){return e.isStakeTransaction},e.showStakeNotification=function(a,n){notify.createNotification(a,{body:"New stake reward: Ɍ"+t("humanize")(n,8,".",","),icon:"icon.png"}),e.audioActive&&e.$parent.audioScripLoaded&&(e.$parent.lastSpeak&&meSpeak.stop(e.$parent.lastSpeak),e.$parent.lastSpeak=meSpeak.speak("New stake reward: "+n+" reddcoins",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"}))},e.removeWallet=function(){var t=e.$parent.wallets.indexOf(e.wallet);e.$parent.wallets.splice(t,1),socket.removeAllListeners(e.wallet),r("wallets",e.$parent.wallets,{expires:1e4})},e.toggleAudio=function(){e.audioActive?(r(e.wallet+"_audio",!1,{expires:1e4}),e.$parent.lastSpeak&&meSpeak.stop(e.$parent.lastSpeak),e.$parent.lastSpeak=meSpeak.speak("You have disabled audio notifications for this address",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"}),e.audioActive=!1):(r(e.wallet+"_audio",!0,{expires:1e4}),e.audioActive=!0,e.$parent.audioScripLoaded?(e.$parent.lastSpeak&&meSpeak.stop(e.$parent.lastSpeak),e.$parent.lastSpeak=meSpeak.speak("You have enabled audio notifications for this address",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"})):$.cachedScript("js/vendor/mespeak.js").done(function(t,a){meSpeak.loadConfig("js/vendor/mespeak_config.json"),meSpeak.loadVoice("js/vendor/voices/en/en.json"),e.$parent.lastSpeak&&meSpeak.stop(e.$parent.lastSpeak),e.$parent.lastSpeak=meSpeak.speak("You have enabled audio notifications for this address",{amplitude:100,pitch:40,speed:150,wordgap:1,variant:"klatt"}),e.$parent.audioScripLoaded=!0}))},e.watchWallet=function(e){socket.emit("subscribe",e.wallet),socket.on(e.wallet,function(t){i.getTransactionData(t).then(function(t){window.setTimeout(function(){e.updateWallet(e)},24e4);var a=t.data;if(e.transactions.push(a),e.isStakeTransaction(a)){var n=-1*a.fees,i=notify.permissionLevel();(i=notify.PERMISSION_DEFAULT)?notify.requestPermission(function(){notify.permissionLevel()==notify.PERMISSION_GRANTED&&e.showStakeNotification(e.wallet,n)}):i==notify.PERMISSION_GRANTED&&e.showStakeNotification(e.wallet,n)}else e.newTransactions?e.newTransactions+=1:e.newTransactions=1})})},e.lastUpdate,e.updateWallet=function(e){e.updatePromise&&a.cancel(e.updatePromise),e.updatePromise=a(function(){if(!(e.lastUpdate&&new Date-e.lastUpdate<1e4)){e.lastUpdate=new Date;var t="http://live.reddcoin.com/api/addr/"+e.wallet+"/balance";n({url:t}).success(function(t,o,r,c){e.balance=t/1e8,s.getTransactionData(e.wallet).then(function(t){if(e.transactions=t.data.txs,e.transactions&&e.transactions.length>0){e.lastTime=0;var n=0;e.totalStaked=0,$.each(e.transactions,function(t,a){e.isStakeTransaction(a)&&a.confirmations>0&&(a.time>e.lastTime&&(e.lastTime=a.time,n=-1*a.fees),(1e3*a.time<e.lastStaked||0==e.lastStaked)&&(e.lastStaked=1e3*a.time),e.totalStaked+=-1*a.fees)}),e.totalStakeTime=e.lastStaked&&e.lastStaked!=Number.POSITIVE_INFINITY?' <td><strong>Total (last <timer start-time="'+e.lastStaked+"\" interval=\"1000\"><span ng-show=\"days\">{{days}}d </span><span ng-show=\"hhours\">{{hhours}}h </span><span ng-show=\"mminutes\">{{mminutes}}m </span><span>{{sseconds}}s</span></timer>)</strong></td><td><strong>Ɍ{{totalStaked | humanize:8:'.':','}}</strong></td><td><strong>฿{{totalStaked* $parent.$parent.rddPrice | humanize:8:'.':','}}</strong></td><td><strong>${{totalStaked * $parent.$parent.rddDollarPrice | humanize:8:'.':','}}</strong></td><td><strong>&gt; 0</strong></td>":0,e.intervalFunction=function(){a(function(){e.lastRewardSeconds=new Date-new Date(1e3*e.lastTime),e.avgPercentage=e.lastTime&&e.lastTime!=Number.POSITIVE_INFINITY?'<span ng-hide="percentage > 1000">{{(percentage = (lastRewardSeconds / (seconds * 1000)) * 100) | humanize:0:\'.\':\',\'}}% of estimate</span><span class="label label-danger" ng-show="percentage > 1000"><span class="glyphicon glyphicon-off" aria-hidden="true"></span> Wallet seems to be offline</span>':0,e.intervalFunction()},1e3)},e.intervalFunction(),e.lastReward=e.lastTime&&e.lastTime!=Number.POSITIVE_INFINITY?'<timer start-time="'+1e3*e.lastTime+'" interval="1000"><span ng-show="days">{{days}} day{{daysS}}, </span><span ng-show="hours">{{hours}} hour{{hoursS}}, </span><span ng-show="minutes">{{minutes}} minute{{minutesS}} and </span><span>{{seconds}} second{{secondsS}}</span> ago</timer>':0}});var d="http://live.reddcoin.com/api/addr/"+e.wallet+"/utxo?noCache=1";n({url:d}).success(function(t,a,s,o){if(t.sort(function(e,t){return new Date(1e3*e.ts)-new Date(1e3*t.ts)}),e.unspendTransactions&&e.unspendTransactions.length!=t.length){var r;$.each(t,function(t,a){new Date(1e3*a.ts)>new Date(1e3*e.unspendTransactions[e.unspendTransactions.length-1].ts)&&a.txid!=r&&(r=a.txid,i.getTransactionData(a.txid).then(function(t){var a=t.data;if(a.confirmations>0)if(e.isStakeTransaction(a)){var n=-1*a.fees,i=notify.permissionLevel();(i=notify.PERMISSION_DEFAULT)?notify.requestPermission(function(){notify.permissionLevel()==notify.PERMISSION_GRANTED&&e.showStakeNotification(e.wallet,n)}):i==notify.PERMISSION_GRANTED&&e.showStakeNotification(e.wallet,n)}else e.newTransactions?e.newTransactions+=1:e.newTransactions=1}))})}e.unspendTransactions=t,e.$parent.$watch("networkWeight",function(t,a){e.updateStakeInfo(e)}),e.latestDiff?(e.latestDiff=e.latestDiffUpdate,e.networkWeight=e.networkWeightUpdate):n({url:"http://live.reddcoin.com/api/status?q=getDifficulty"}).success(function(t,a,n,i){e.latestDiff=t.difficulty,e.networkWeight=Math.round(4294967296*e.latestDiff/60)}).error(function(e,t,a,n){console.log("error",e)})}).error(function(e,t,a,n){console.log("error",e)})}).error(function(e,t,a,n){console.log("error",e)})}},1e3)},e.$on("timer-stopped",function(t,a){0==a.seconds&&t.targetScope.countdownattr==e.countdown&&e.updateWallet(e)}),e.updateStakeInfo=function(e){e.totalcoinweight=0;var t=0;$.each(e.unspendTransactions,function(a,n){nowtime=Math.round((new Date).getTime()/1e3);var i=nowtime-n.ts-28800,s=i/60/60/24,o=0;t=7>=s?-.00408163*Math.pow(s,3)+.05714286*Math.pow(s,2)+s:8.4*Math.log(s)-7.94564525,n.confirmations>=0&&(o=t*n.amount),o>=0&&(e.totalcoinweight+=o)}),e.seconds=Math.round(e.$parent.networkWeight/e.totalcoinweight*60).toFixed(0),e.countdown=Math.min(e.seconds,1800),e.avgStakeTimespan=e.seconds&&e.seconds!=Number.POSITIVE_INFINITY?'<timer interval="1000" start-time="'+((new Date).getTime()-1e3*e.seconds)+'" end-time="'+((new Date).getTime()-1e3*e.seconds)+'" autostart="false"><span ng-show="days">{{days}} day{{daysS}}, </span><span ng-show="hours">{{hours}} hour{{hoursS}}, </span><span ng-show="minutes">{{minutes}} minute{{minutesS}} and </span><span>{{seconds}} second{{secondsS}}</span></timer>':0,e.estStakeTimespan=e.seconds&&e.seconds!=Number.POSITIVE_INFINITY?'<timer countdown="'+e.countdown+'" interval="1000"><div class="progress active"> <div class="progress-bar progress-bar-info" ng-style="{\'width\': ((countdown/$parent.countdown) * 100) + \'%\'}"><span>&nbsp;&nbsp;</span><span ng-show="days">{{days}} day{{daysS}}, </span><span ng-show="hours">{{hours}} hour{{hoursS}}, </span><span ng-show="minutes">{{minutes}} minute{{minutesS}} and </span><span>{{seconds}} second{{secondsS}}</span></div> </div></timer>':"not staking because the address doesn't have mature coins",e.estStake=(Math.round(e.$parent.networkWeight/e.totalcoinweight)/60).toFixed(2),e.estStakeInDays=(e.estStake/24).toFixed(2),e.$broadcast("timer-start")},e.openShareLayer=function(t){var a="http://reddcoin.rocks/#"+e.wallet;e.shortLink?e.openShareLayerInternal(t):(e.shorteningUrl=!0,o.getShortUrl(a).then(function(a){e.shortLink=a.data.shorturl,e.shorteningUrl=!1,e.openShareLayerInternal(t)},function(n){e.shortLink=a,e.shorteningUrl=!1,e.openShareLayerInternal(t)}))},e.openShareLayerInternal=function(t){c.open({templateUrl:"sharelayer.html",controller:"shareLayer",size:t,resolve:{shortLink:function(){return e.shortLink},wallet:function(){return e.wallet}}})},e.wallet&&34==e.wallet.length&&(e.updateWallet(e),e.watchWallet(e),e.audioActive&&!e.$parent.audioScripLoaded&&$.cachedScript("js/vendor/mespeak.js").done(function(t,a){meSpeak.loadConfig("js/vendor/mespeak_config.json"),meSpeak.loadVoice("js/vendor/voices/en/en.json"),e.$parent.audioScripLoaded=!0}))}]),reddcoinRocks.controller("shareLayer",["$scope","$modalInstance","shortLink","wallet",function(e,t,a,n){e.shortLink=a,e.wallet=n,e.cancel=function(){t.dismiss("cancel")}}]),reddcoinRocks.controller("stakingInfo",["$scope","$http","btcPriceService","rddPriceService","$pusher","ipCookie","$activityIndicator",function(e,t,a,n,i,s,o){e.btcPriceUp=!0,e.rddPriceUp=!0,e.rddDollarPriceUp=!0,e.audioScripLoaded=!1;var r=document.createElement("audio");e.canPlayAudioNotifications="function"==typeof r.canPlayType&&""!==r.canPlayType("audio/x-wav"),window.location.hash&&36==window.location.hash.length&&(e.address=window.location.hash.substring(2)),e.wallets=(e.address?[e.address]:s("wallets"))||[],e.wallets.length>0&&o.startAnimating(),t({url:"http://live.reddcoin.com/api/status?q=getDifficulty"}).success(function(t,a,n,i){e.latestDiff=t.difficulty,e.networkWeight=Math.round(4294967296*e.latestDiff/60),o.stopAnimating()}).error(function(e,t,a,n){console.log("error",e)}),socket.on("connect",function(){socket.emit("subscribe","inv")}),socket.on("block",function(a){t({url:"http://live.reddcoin.com/api/status?q=getDifficulty"}).success(function(t,a,n,i){e.latestDiffUpdate=t.difficulty,e.networkWeightUpdate=Math.round(4294967296*e.latestDiffUpdate/60)}).error(function(e,t,a,n){console.log("error",e)})}),e.updateRddDollarPrice=function(t,a){if(t||a){var n=(a*t).toFixed(8);n>e.rddDollarPrice&&(e.rddDollarPriceUp=!0),n<e.rddDollarPrice&&(e.rddDollarPriceUp=!1),e.rddDollarPrice=n}};var c=new Pusher("cb65d0a7a72cd94adf1f"),d=i(c),l=new Pusher("de504dc5763aeef9ff52"),p=i(l);a.getPrice().then(function(t){t.data.bitstamp&&t.data.bitstamp.rates.last&&(e.btcPrice=t.data.bitstamp.rates.last,e.updateRddDollarPrice(e.btcPrice,e.rddPrice))}),p.subscribe("live_trades").bind("trade",function(t){t.price>e.btcPrice&&(e.btcPriceUp=!0),t.price<e.btcPrice&&(e.btcPriceUp=!1),e.btcPrice=t.price,e.updateRddDollarPrice(e.btcPrice,e.rddPrice)}),n.getPrice().then(function(t){t.data.query.results&&"true"==t.data.query.results.json.success&&t.data.query.results.json.result.Last&&(e.rddPrice=t.data.query.results.json.result.Last,e.updateRddDollarPrice(e.btcPrice,e.rddPrice))}),d.subscribe("trade.169").bind("message",function(t){t.trade.price>e.rddPrice&&(e.rddPriceUp=!0),t.trade.price<e.rddPrice&&(e.rddPriceUp=!1),e.rddPrice=t.trade.price,e.updateRddDollarPrice(e.btcPrice,e.rddPrice)}),e.getBalance=function(){e.wallet&&34==e.wallet.length&&$.inArray(e.wallet,e.wallets)&&(e.wallets.push(e.wallet),e.wallet="",s("wallets",e.wallets,{expires:1e4}))}}]);